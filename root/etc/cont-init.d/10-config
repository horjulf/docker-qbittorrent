#!/usr/bin/with-contenv sh

# Config and data folders
QB_CONFIG="${XDG_CONFIG_HOME}/qBittorrent"
QB_DATA="${XDG_DATA_HOME}/data"
# Old config and data folders
OLD_QB_CONFIG="${HOME}/.config/qBittorrent"
OLD_QB_DATA="${HOME}/.local/share/data"
# Config file
QB_CONFIG_FILE="${QB_CONFIG}/qBittorrent.conf"

# Migrate old config path to new XDG_CONFIG_HOME
if [ -d "${OLD_QB_CONFIG}" ] && [ ! -d "${QB_CONFIG}" ]; then
    echo "*** Migrating \"${OLD_QB_CONFIG}\" to \"${QB_CONFIG}\""
    mv "${OLD_QB_CONFIG}" "${QB_CONFIG}" \
    && rmdir "$(dirname "${OLD_QB_CONFIG}")"
fi

# Migrate old data path to new XDG_DATA_HOME
if [ -d "${OLD_QB_DATA}" ] && [ ! -d "${QB_DATA}" ]; then
    echo "*** Migrating \"${OLD_QB_DATA}\" to \"${QB_DATA}\""
    mv "${OLD_QB_DATA}" "${QB_DATA}" \
    && rmdir "$(dirname "${OLD_QB_DATA}")" "$(dirname "$(dirname "${OLD_QB_DATA}")")"
fi

# Folders
mkdir -p \
    "${QB_CONFIG}" \
    /config/log

# https://github.com/qbittorrent/qBittorrent/blob/master/src/base/settingsstorage.cpp
if [ ! -f "${QB_CONFIG_FILE}" ]; then
  echo "Initializing qBittorrent configuration..."
  cat > "${QB_CONFIG_FILE}" <<EOL
[Application]
FileLogger\Enabled=true
FileLogger\Path=/config/log

[Preferences]
Connection\PortRangeMin=54243
Connection\ResolvePeerCountries=false
Connection\UPnP=false
Downloads\FinishedTorrentExportDir=/downloads/torrents
Downloads\PreAllocation=true
Downloads\SavePath=/downloads/incoming
General\Locale=en
General\UseRandomPort=false
WebUI\Address=*
WebUI\Port=8080
WebUI\LocalHostAuth=true
EOL
fi

# Permissions
chown -R abc:abc \
    /config
